<!DOCTYPE html>
<html>
  <head>
    <title>Checkout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f8f9fa;
      }
      .checkout-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      #cart-summary {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
      }
      .checkout-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      .checkout-item:last-child {
        border-bottom: none;
      }
      .item-info {
        flex: 1;
      }
      .item-name {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .item-details {
        color: #666;
        font-size: 14px;
      }
      .checkout-totals {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #ddd;
      }
      .total-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
      }
      .total-row.total {
        font-size: 18px;
        border-top: 1px solid #ddd;
        padding-top: 10px;
        margin-top: 10px;
      }
      .paypal-button-container {
        max-width: 400px;
        margin: 20px auto;
      }
      .payment-message {
        text-align: center;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .back-to-cart {
        display: inline-block;
        margin-bottom: 20px;
        padding: 10px 15px;
        background: #6c757d;
        color: white;
        text-decoration: none;
        border-radius: 5px;
      }
      .back-to-cart:hover {
        background: #5a6268;
      }
      .payment-section {
        margin-top: 30px;
        padding: 25px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: #fff;
      }
      .payment-section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 10px;
      }
      .loading-spinner {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .payment-info {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #28a745;
      }
    </style>
  </head>
  <body>
    <div class="checkout-container">
      <a href="cart.html" class="back-to-cart">‚Üê Back to Cart</a>
      <h1>Complete Your Order</h1>

      <div id="cart-summary">
        <h3>Order Summary</h3>
        <div id="checkout-items"></div>
        <div class="checkout-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span id="checkout-subtotal">$0.00</span>
          </div>
          <div class="total-row">
            <span>Shipping:</span>
            <span id="checkout-shipping">$0.00</span>
          </div>
          <div class="total-row">
            <span>Tax:</span>
            <span id="checkout-tax">$0.00</span>
          </div>
          <div class="total-row total">
            <strong>
              <span>Total:</span>
              <span id="checkout-total">$0.00</span>
            </strong>
          </div>
        </div>
      </div>

      <div id="payment-message"></div>

      <!-- Payment Options -->
      <div class="payment-section">
        <h3>Payment Method</h3>
        <p>Complete your purchase securely with PayPal</p>

        <!-- PayPal Button Container -->
        <div id="paypal-button-container" class="paypal-button-container">
          <div
            class="loading-spinner"
            style="text-align: center; padding: 20px; color: #666"
          >
            Loading payment options...
          </div>
        </div>

        <!-- Alternative payment info -->
        <div class="payment-info">
          <p
            style="
              font-size: 12px;
              color: #666;
              text-align: center;
              margin-top: 15px;
            "
          >
            üîí Secure payment powered by PayPal<br />
            No PayPal account required - you can pay with debit/credit card
          </p>
        </div>
      </div>
    </div>

    <!-- PayPal SDK - Sandbox for testing -->
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD&intent=capture&disable-funding=credit,card"></script>

    <script>
      // Load cart data and display checkout summary
      function loadCheckoutData() {
        const cart = JSON.parse(localStorage.getItem("artshop_cart") || "{}");
        const checkoutTotal = localStorage.getItem("checkoutTotal") || "0.00";

        const checkoutItemsContainer =
          document.getElementById("checkout-items");
        const cartItems = Object.entries(cart);

        if (cartItems.length === 0) {
          checkoutItemsContainer.innerHTML =
            '<p>Your cart is empty. <a href="products.html">Continue Shopping</a></p>';
          document.getElementById("paypal-button-container").style.display =
            "none";
          return;
        }

        // Display cart items
        checkoutItemsContainer.innerHTML = cartItems
          .map(
            ([sku, item]) => `
            <div class="checkout-item">
              <div class="item-info">
                <div class="item-name">${item.name}</div>
                <div class="item-details">Quantity: ${
                  item.qty
                } √ó $${item.price.toFixed(2)}</div>
              </div>
              <div class="item-total">$${(item.price * item.qty).toFixed(
                2
              )}</div>
            </div>
          `
          )
          .join("");

        // Calculate totals
        const subtotal = Object.values(cart).reduce(
          (sum, item) => sum + item.price * item.qty,
          0
        );
        const shipping = 0.0; // Free shipping
        const tax = 0.0; // No tax
        const total = subtotal + shipping + tax;

        // Update totals display
        document.getElementById(
          "checkout-subtotal"
        ).textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById(
          "checkout-shipping"
        ).textContent = `$${shipping.toFixed(2)}`;
        document.getElementById("checkout-tax").textContent = `$${tax.toFixed(
          2
        )}`;
        document.getElementById(
          "checkout-total"
        ).textContent = `$${total.toFixed(2)}`;
      }

      // Initialize everything when page loads
      window.addEventListener("load", initializeCheckout);

      // Standalone PayPal Payment Plugin
      function initializePayPalButton() {
        // Get current cart total
        const totalElement = document.getElementById("checkout-total");
        const totalAmount = totalElement
          ? totalElement.textContent.replace("$", "")
          : "0.00";

        if (parseFloat(totalAmount) <= 0) {
          document.getElementById("paypal-button-container").innerHTML =
            '<p style="text-align: center; color: #666;">Add items to cart to enable checkout</p>';
          return;
        }

        paypal
          .Buttons({
            // Set up the transaction
            createOrder: function (data, actions) {
              const cart = JSON.parse(
                localStorage.getItem("artshop_cart") || "{}"
              );
              const cartItems = Object.entries(cart);

              // Create purchase units from cart items
              const items = cartItems.map(([sku, item]) => ({
                name: item.name,
                unit_amount: {
                  currency_code: "USD",
                  value: item.price.toFixed(2),
                },
                quantity: item.qty.toString(),
                sku: sku,
                category: "DIGITAL_GOODS",
              }));

              const subtotal = Object.values(cart).reduce(
                (sum, item) => sum + item.price * item.qty,
                0
              );

              return actions.order.create({
                purchase_units: [
                  {
                    reference_id: "ARTSHOP_" + Date.now(),
                    amount: {
                      currency_code: "USD",
                      value: subtotal.toFixed(2),
                      breakdown: {
                        item_total: {
                          currency_code: "USD",
                          value: subtotal.toFixed(2),
                        },
                        shipping: {
                          currency_code: "USD",
                          value: "0.00",
                        },
                        tax_total: {
                          currency_code: "USD",
                          value: "0.00",
                        },
                      },
                    },
                    items: items,
                    shipping: {
                      method: "Digital Delivery",
                      address: {
                        address_line_1: "Digital Product",
                        admin_area_2: "N/A",
                        admin_area_1: "N/A",
                        postal_code: "00000",
                        country_code: "US",
                      },
                    },
                  },
                ],
                application_context: {
                  brand_name: "ArtShop Inc.",
                  landing_page: "NO_PREFERENCE",
                  shipping_preference: "NO_SHIPPING",
                  user_action: "PAY_NOW",
                },
              });
            },

            // Handle successful payment
            onApprove: function (data, actions) {
              return actions.order
                .capture()
                .then(function (details) {
                  // Payment successful
                  console.log("Payment completed successfully:", details);

                  // Clear cart after successful payment
                  localStorage.removeItem("artshop_cart");
                  localStorage.removeItem("checkoutTotal");

                  // Show success message
                  showMessage(
                    `Payment successful! Transaction ID: ${details.id}. Thank you for your purchase!`,
                    "success"
                  );

                  // Disable PayPal button
                  document.getElementById(
                    "paypal-button-container"
                  ).style.display = "none";

                  // Add order summary to localStorage for success page
                  localStorage.setItem(
                    "lastOrder",
                    JSON.stringify({
                      orderId: details.id,
                      amount: details.purchase_units[0].amount.value,
                      items: details.purchase_units[0].items || [],
                      timestamp: new Date().toISOString(),
                      status: "completed",
                    })
                  );

                  // Redirect to products page after delay
                  setTimeout(function () {
                    if (
                      confirm(
                        "Order completed! Would you like to continue shopping?"
                      )
                    ) {
                      window.location.href = "products.html";
                    } else {
                      window.location.href = "index.html";
                    }
                  }, 3000);

                  return details;
                })
                .catch(function (error) {
                  console.error("Error capturing payment:", error);
                  showMessage(
                    "Payment processing failed. Please try again or contact support.",
                    "error"
                  );
                });
            },

            // Handle payment errors
            onError: function (err) {
              console.error("PayPal error:", err);
              showMessage(
                "An error occurred during payment. Please try again or contact support.",
                "error"
              );
            },

            // Handle payment cancellation
            onCancel: function (data) {
              console.log("Payment cancelled by user:", data);
              showMessage(
                "Payment was cancelled. You can try again when ready.",
                "error"
              );
            },

            // PayPal button styling
            style: {
              layout: "vertical",
              color: "gold",
              shape: "rect",
              label: "paypal",
              height: 50,
              tagline: false,
            },
          })
          .render("#paypal-button-container")
          .catch(function (err) {
            console.error("Failed to render PayPal button:", err);
            showMessage(
              "Failed to load payment system. Please refresh the page.",
              "error"
            );
          });
      }

      // Initialize PayPal when page loads and cart data is ready
      function initializeCheckout() {
        loadCheckoutData();

        // Wait a moment for DOM to update, then initialize PayPal
        setTimeout(function () {
          initializePayPalButton();
        }, 100);
      }

      // Helper function to show messages
      function showMessage(message, type) {
        const messageDiv = document.getElementById("payment-message");
        messageDiv.textContent = message;
        messageDiv.className = "payment-message " + type;
      }
    </script>
  </body>
</html>
